name: NGOL-D CI
on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    services:
      mariadb:
        image: mariadb:10.11
        env:
          MARIADB_ROOT_PASSWORD: root
          MARIADB_DATABASE: NGOL_D
          MARIADB_USER: ngol
          MARIADB_PASSWORD: ngol
        ports: ["3306:3306"]
        options: >-
          --health-cmd="mariadb-admin ping"
          --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
      - name: Cache Nix store
        uses: actions/cache@v4
        with:
          path: /nix/store
          key: nix-${{ hashFiles('flake.lock') }}
      - name: Format check
        run: nix fmt --check || true
      - name: Build App & Backend
        run: nix build .#App .#Backend
      - name: Run tests with MariaDB
        run: nix run .#check
        env:
          MARIADB_HOST: 127.0.0.1
          MARIADB_PORT: 3306
          MARIADB_USER: ngol
          MARIADB_PASSWORD: ngol
          MARIADB_DATABASE: NGOL_D
          NODE_ENV: test
      - name: Smoke test
        run: |
          nix run .#Backend &
          BACKEND_PID=$!
          sleep 5
          (cd App && npm run dev) &
          FRONTEND_PID=$!
          for i in {1..15}; do
            curl -s http://localhost:3000/api/health && curl -s http://localhost:5173 && break
            sleep 2
          done
          curl --fail http://localhost:5173
          curl --fail http://localhost:3000/api/health
          kill $BACKEND_PID $FRONTEND_PID 2>/dev/null || true
